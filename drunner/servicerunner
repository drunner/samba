#!/bin/bash
                                                                                                                                                          
#  ad88888ba                                        88                          88888888ba                                                                  
# d8"     "8b                                       ""                          88      "8b                                                                 
# Y8,                                                                           88      ,8P                                                                 
# `Y8aaaaa,     ,adPPYba,  8b,dPPYba,  8b       d8  88   ,adPPYba,   ,adPPYba,  88aaaaaa8P'  88       88  8b,dPPYba,   8b,dPPYba,    ,adPPYba,  8b,dPPYba,  
#   `"""""8b,  a8P_____88  88P'   "Y8  `8b     d8'  88  a8"     ""  a8P_____88  88""""88'    88       88  88P'   `"8a  88P'   `"8a  a8P_____88  88P'   "Y8  
#         `8b  8PP"""""""  88           `8b   d8'   88  8b          8PP"""""""  88    `8b    88       88  88       88  88       88  8PP"""""""  88          
# Y8a     a8P  "8b,   ,aa  88            `8b,d8'    88  "8a,   ,aa  "8b,   ,aa  88     `8b   "8a,   ,a88  88       88  88       88  "8b,   ,aa  88          
#  "Y88888P"    `"Ybbd8"'  88              "8"      88   `"Ybbd8"'   `"Ybbd8"'  88      `8b   `"YbbdP'Y8  88       88  88       88   `"Ybbd8"'  88          



#------------------------------------------------------------------------------------
# Initialisation of globals.

# bail if we try and use an unset var
set -o nounset

# Determine the current directory. There's stuff in there we want.
MYDIR=$( dirname "$(readlink -f "$0")" )

# read shell includes autogenerated by dRunner for us (it makes them when we're installed).
source "$MYDIR/variables.sh"
source "$MYDIR/utils.sh"

# pretty printing of code.
e=$(printf "\e") 
readonly CODE_S="$e[32m"
readonly CODE_E="$e[0m"


#------------------------------------------------------------------------------------
# showhelp - give some info about the service. SERVICENAME and IMAGENAME are provided by variables.sh.

function showhelp {
cat <<EOF >&2

NAME
   ${SERVICENAME} - Makes host paths available via samba.
       
SYNOPSIS
   ${SERVICENAME} help           

   ${SERVICENAME} share [OPTION]... HOSTPATH SHARENAME
   ${SERVICENAME} [PASSWORD=?] user add USERNAME [PASSWORD]
   ${SERVICENAME} [PASSWORD=?] user password USERNAME [PASSWORD]
   ${SERVICENAME} user delete USERNAME
   ${SERVICENAME} getshares
   
   ${SERVICENAME} start           
   ${SERVICENAME} stop            
   ${SERVICENAME} status         
      
DESCRIPTION
   Built from ${IMAGENAME}.
   
EOF
}

#------------------------------------------------------------------------------------
# Run a command in the container. 

function dockerrun {
   local RVAL=0
   docker run "${COMMANDOPTS[@]}" --name="${SERVICENAME}-${COMMAND}" -h "${HOSTNAME}" "${DOCKEROPTS[@]}" "${IMAGENAME}" "$@"
   RVAL=$?
   docker rm "${SERVICENAME}-${COMMAND}" >/dev/null
   [ $RVAL -eq 0 ] || die "${SERVICENAME} ${COMMAND} failed."
}

#------------------------------------------------------------------------------------
# Run a detached command in the container. 

# detached, can't remove.
function dockerrund {
   docker run -d "${COMMANDOPTS[@]}" --name="${SERVICENAME}-${COMMAND}" -h "${HOSTNAME}" -v "/root:/share/root" "${DOCKEROPTS[@]}" "${IMAGENAME}"
   # "$@"
   [ $? -eq 0 ] || die "${SERVICENAME} ${COMMAND} failed."
}

#------------------------------------------------------------------------------------
# Display the status of the service.

function showStatus {
   container_exists "${SERVICENAME}-start"  || { echo "${SERVICENAME}'s container is stopped and removed." ; exit 0 ; }
   container_running "${SERVICENAME}-start" || { echo "${SERVICENAME}'s container is stopped but not removed." ; exit 0 ; }
   getPort
   echo "Samba is running on ${HOSTIP}."   
}

#------------------------------------------------------------------------------------
# check if running, if so stop it.

function stopService {
   ! container_running "${SERVICENAME}-start" || docker stop --time=30 "${SERVICENAME}-start" >/dev/null 2>&1
   ! container_exists "${SERVICENAME}-start"  || docker rm "${SERVICENAME}-start" >/dev/null 2>&1
}

#------------------------------------------------------------------------------------
# The main function. We can add any commands we'd like here!

function main {
   [ "$#" -gt 0 ] || die "servicerunner must have the install argument."

   COMMAND="${1}" ; shift
   COMMANDOPTS=("-i")
   
   case "$COMMAND" in 
         install)
            dockerrun sudo "docker-smb-populate"
            ;;
         
         getshares)
            dockerrun sudo "docker-smb-getshares"   
            ;;
           
         obliterate)
            stopService
            ;;
                     
         uninstall)
            stopService
            ;;

         backupstart)
            # all volumes are automatically backed up, we just need to pause the service so it's
            # warm not hot!
            #BACKUPPATH="$1"
            ! container_running "${SERVICENAME}-start" || docker pause "${SERVICENAME}-start"
            ;;

         backupend)
            # resume if paused.
            #BACKUPPATH="$1"
            ! container_paused "${SERVICENAME}-start" || docker unpause "${SERVICENAME}-start" 
            ;;
         
         restore)
            # restore only ever called into empty service
            #RESTOREPATH="$1"
            ! container_running "${SERVICENAME}-start" || die "${SERVICENAME} is running while restoring! This should never happen as restore should only work to an empty service."
            ;;
         
         help)
            showhelp
            ;;
         
         enter)
            COMMANDOPTS=("-it")
            dockerrun /bin/bash "$@"
            ;;
         
         updatestart)
            ! container_running "${SERVICENAME}-start" || { stopService ; echo "${SERVICENAME} was running, it has been stopped." ; }
            ;;

         updateend)
            ;;
         
         selftest)
            ;;
            
         start)
            ! container_running "${SERVICENAME}-start" || die "Already running" 3 
            ! container_exists "${SERVICENAME}-start"  || docker rm "${SERVICENAME}-start" >/dev/null 2>&1

            COMMANDOPTS=("-p" "137:137/udp" "-p" "138:138/udp" "-p" "135:135" "-p" "139:139" "-p" "445:445" "--restart=always")
            dockerrund 
            showStatus
            ;;
         
         stop)
            stopService
            echo "New Status:"
            showStatus   
            ;;
         
         status)
            showStatus
            ;;
            
         share)
            #! container_running "${SERVICENAME}-start" || die "Can't configure while ${SERVICENAME} is started. Stop it first."
            dockerrun sudo "docker-smb-share" "$@"
            ;;

         user)
            #! container_running "${SERVICENAME}-start" || die "Can't configure while ${SERVICENAME} is started. Stop it first."
            [ ! -v PASSWORD ] || [ -z "$PASSWORD" ] || COMMANDOPTS=("-i" "-e" "PASSWORD=$PASSWORD")
            dockerrun sudo "docker-smb-user" "$@"
            ;;
            
         *)
            showhelp
            die "Unrecognised command ${CODE_S}${COMMAND}${CODE_E}"            
            ;;
   esac
}

#------------------------------------------------------------------------------------

main "$@"
